version: "3.8"

services:
  postgres:
    image: postgres:15-alpine
    container_name: package_management_db
    restart: unless-stopped
    environment:
      POSTGRES_DB: package_management
      POSTGRES_USER: packageadmin
      POSTGRES_PASSWORD: packagepass123
      POSTGRES_INITDB_ARGS: "--auth-host=scram-sha-256 --auth-local=scram-sha-256"
      PGDATA: /var/lib/postgresql/data/pgdata
      # Enable more verbose logging to debug init scripts
      POSTGRES_HOST_AUTH_METHOD: scram-sha-256
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init-scripts:/docker-entrypoint-initdb.d:ro
    networks:
      - app_network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U packageadmin -d package_management"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    command: >
      postgres -c log_statement=all 
               -c log_destination=stderr 
               -c log_min_messages=notice
               -c log_checkpoints=on 
               -c log_connections=on 
               -c log_disconnections=on

  # app:
  #   build: .
  #   container_name: application_gateway
  #   restart: unless-stopped
  #   depends_on:
  #     postgres:
  #       condition: service_healthy
  #   environment:
  #     # Database
  #     DB_HOST: postgres
  #     DB_PORT: 5432
  #     DB_NAME: package_management
  #     DB_USER: packageadmin
  #     DB_PASSWORD: packagepass123

  #     # JWT
  #     JWT_SECRET: your-super-secret-jwt-key-change-this
  #     JWT_EXPIRES_IN: 24h

  #     # MFA
  #     MFA_ISSUER: PackageManagement
  #     MFA_APP_NAME: Package Management System

  #     # Server
  #     PORT: 3000
  #     NODE_ENV: development

  #     # Hyperledger Fabric
  #     CHANNEL_NAME: releasechannel
  #     CHAINCODE_NAME: SoftwareReleaseContract
  #     MSP_ID: Org1MSP
  #     CRYPTO_PATH: /app/crypto
  #     PEER_ENDPOINT: localhost:7051
  #     PEER_HOST_ALIAS: peer0.org1.example.com

  #     # Admin
  #     ADMIN_MSP_IDS: Org1MSP

  #     # Email
  #     MAILTRAP_TOKEN: ""
  #     MAILTRAP_SENDER_EMAIL: noreply@packagemanagement.example.com
  #     MAILTRAP_SENDER_NAME: Package Management System
  #   ports:
  #     - "3000:3000"
  #   volumes:
  #     - ./crypto:/app/crypto
  #   networks:
  #     - app_network

volumes:
  postgres_data:

networks:
  app_network:
    driver: bridge
